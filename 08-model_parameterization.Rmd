# Model Parameterization

These sections are not detailed enough to warrant their own dedicated chapter.

## Parameter Changes

These sections mostly involve changing a few parameter values and are therefore in small sub sections without R-code. Some of this might change later.

### Channel parameters revised

This an ongoing unresolved issue [#49](https://gitlab.nibio.no/moritzshore/swat-cs10/-/issues/49).

So far nothing has been changed.

### Crop parameters verified

The crop database has been updated and stored in the following file:

```{r, mod_par_plt, eval=FALSE}
"model_data/cs10_setup/swat_input_mod/plants.plt"
```

Discussions to this topic can be found in issue [#27](https://gitlab.nibio.no/moritzshore/swat-cs10/-/issues/27).

From the whole database, we only use crops defined in our management files:

Crop management: oats, barl, wwht, swht, pota, fesc

Generic: frst, fesc and others which are minor

The parameters for these crops have been updated to reflect the colder growing
conditions.

### Soil physical parameters in final form

This has been mentioned in issue [#28](https://gitlab.nibio.no/moritzshore/swat-cs10/-/issues/28), and has been closed without discussion. Seems like the parameters are in final form, but no further documentation exists at this point.

### Soil chemical parameters in final form

This step will be verified in issue [#46](https://gitlab.nibio.no/moritzshore/swat-cs10/-/issues/46). It has been discussed in [#19](https://gitlab.nibio.no/moritzshore/swat-cs10/-/issues/19).

The following changes have been implemented, but are subject to change:

| Parameter    | Default | CS10 |
|--------------|---------|------|
| `lab_p`      | 5       | 20   |
| `nitrate`    | 7       | 8.5  |
| `inorgp`     | 3.5     | 35.1 |
| `watersol_p` | 0.15    | 0.4  |

: Changes made to `soilnut1` of `nutrients.sol`

```{r, mod_par_nutsol}

nutrients_sol <- readLines("model_data/cs10_setup/swat_input/nutrients.sol")

header <- nutrients_sol[1]

nutrients_sol_df <- read.table("model_data/cs10_setup/swat_input/nutrients.sol", header = T, skip = 1, sep = "", fill = T, as.is = T, colClasses = "character")

nutrients_sol_df$lab_p <- 20
nutrients_sol_df$nitrate <- 8.5
nutrients_sol_df$inorgp <- 35.1
nutrients_sol_df$watersol_p <- 0.4

write.table(
  nutrients_sol_df,
  "model_data/cs10_setup/swat_input_mod/nutrients.sol",
  quote = F,
  sep = "   ",
  row.names = F, 
)

header_new <- paste(header, "and modified by the CS10 workflow on", Sys.time())

nutrients_sol <- readLines("model_data/cs10_setup/swat_input_mod/nutrients.sol")

writeLines(c(header_new, nutrients_sol), "model_data/cs10_setup/swat_input_mod/nutrients.sol")
```

Testing if the setup still works:

```{r, mod_par_testswat1, eval = FALSE}
simout <- test_swat_mod()
cat(tail(simout), sep = "\n")
```


### Impoundment parameters defined

Has been postponed by [#20](https://gitlab.nibio.no/moritzshore/swat-cs10/-/issues/20), will be dealt with in [#54](https://gitlab.nibio.no/moritzshore/swat-cs10/-/issues/54)

### Water diversions defined

Deemed as not relevant for this catchment

### Point sources parameters added

Is an ongoing issue in [#21](https://gitlab.nibio.no/moritzshore/swat-cs10/-/issues/21)

### Tile drainage parameters defined

Is an ongoing issue in [#53](https://gitlab.nibio.no/moritzshore/swat-cs10/-/issues/53).

```{r, mod_par_tiledrainset}
old_path <- "model_data/cs10_setup/swat_input/tiledrain.str"
new_path <-  "model_data/cs10_setup/swat_input_mod/tiledrain.str"

tiledrain_str <- readLines(old_path)

header <- tiledrain_str[1]

header <- paste(header, "then modified by CS10 workflow at", Sys.time())

tiledrain_df <-
  read.table(
    old_path,
    sep = "",
    header = T,
    skip = 1,
    fill = T,
    colClasses = "character"
  )

tiledrain_df$dp <- 800 # from 1000
tiledrain_df$t_fc <- 12 # from 24
tiledrain_df$lag <- 30 # from 96
tiledrain_df$rad <- 200 # from 100
tiledrain_df$dist <- 8000 # from 30
tiledrain_df$drain <- 40 # from 10
tiledrain_df$pump <- 0 # from 1
tiledrain_df$lat_ksat <- 2 # from 2 (no change)

write.table(header, file = new_path, quote = F, col.names = F, row.names = F)
write.table(
  x = tiledrain_df,
  file = new_path,
  sep = "   ",
  quote = F,
  append = T,
  row.names = F
)
```
Testing if the setup still works:

```{r, mod_par_testswat2, eval = FALSE}
simout <- test_swat_mod()
cat(tail(simout), sep = "\n")
```


### Atmospheric deposition defined

Has been done in section REF


### Additional settings verified

Refers to chapter 3.11 in The Protocol and files `parameters.bsn` `codes.bsn`
Has been discussed in
[#22](https://gitlab.nibio.no/moritzshore/swat-cs10/-/issues/22)


The following changes have been made:

| Parameter   | Default | CS10 |
|-------------|---------|------|
| `pet`       | 1       | 2    |
| `rte_cha`   | 0       | 1    |
| `cn`        | 0       | 1    |
| `tiledrain` | 0       | 1    |
| `soil_p`    | 0       | 1    |
| `atmo_dep`  | a       | m    |
|             |         |      |

: Changes made to `codes.bsn`

```{r, mod_par_codes_bsn}
old_path <- "model_data/cs10_setup/swat_input/codes.bsn"
new_path <- "model_data/cs10_setup/swat_input_mod/codes.bsn"

codes_bsn <- readLines(old_path)

header <- codes_bsn[1]

header <- paste(header, "then modified by CS10 workflow on", Sys.time())

codes_df <- read.table(old_path, skip = 1, header = T, sep = "", 
                       colClasses = "character")
```

**PET method** (pet) The OPTAIN project recommends the PET calculation of  Pennman-Monteith, which
is code 2.

```{r, mod_par_pet}
codes_df$pet <- 2 
```

**Channel routing network** (rte_cha) Recommended is to start with Muskingum (code 1) and apply variable storage
method if it causes problems.

```{r, mod_par_rte_cha}
codes_df$rte_cha <- 1
```

**Stream water quality** (wq_cha) Recommended to test both for OPTAIN (1/0)

**Daily curve number calculation** (cn) Code 1 is recommended. (Plant ET)

```{r, mod_par_cn}
codes_df$cn <- 1
```

OPTAIN recommends new version

```{r, mod_par_soil_p}
codes_df$soil_p <- 1
```

Lapse rate is being tested in REF

Plant growth stress is being testing in REF

**Tile drainage**

This should be set to 1, but that causes a crash. We will fix this bug in a 
dedicated secton (REF)

```{r, mod_par_tiledrain}
codes_df$tiledrain <- 0
```

Atmosdep was done in REF and is annual

```{r, mod_par_atmodep}
codes_df$atmo_dep <- "y"
```

Writing the changes

```{r, mod_par_write_codes_bsn}
write.table(header, file = new_path, col.names = F, row.names = F, quote = F) 


write.table(
  codes_df,
  file = new_path,
  col.names = T,
  append = T,
  quote = F,
  sep = "   ",
  row.names = F
)
```
Testing if the setup still works:

```{r, mod_par_testswat3, eval = FALSE}
simout <- test_swat_mod()
cat(tail(simout), sep = "\n")
```
