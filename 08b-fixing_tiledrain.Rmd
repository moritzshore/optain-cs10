## Fixing Tiledrain

```{r, drainfix_runthischapter}
run_this_chapter = FALSE
```

Problem: `tiledrain=1` in `codes.bsn` causes crash.

Reason: Some HRUs have drains, but are on a shallow soil type. This causes the drains to be below the soil, leading to a (nondescript) error.

Likely source of error: Misalignment of the soil and land use map.

```{r, drainfix_libs, message=FALSE}
require(mapview)
require(sf)
require(stringr)
require(dplyr)
require(purrr)
require(DT)
```

### Finding the problem HRUs

Our drains are set to 80cm depth. Which of our soils are less than that?

```{r, drainfix_usersol}
usersoil <- readr::read_csv("model_data/input/soil/UserSoil_Krakstad.csv", show_col_types = F)

shallow_soils <- usersoil$SNAM[which(usersoil$SOL_ZMX<800)]

print(shallow_soils)
```

Which of our HRUs use these soils, and are drained?

```{r, drainfix_intersect}
hru_data <- read.table( "model_data/cs10_setup/swat_input/hru-data.hru",
                        skip = 1, header = T, sep = "")

shallow_hrus <- which(hru_data$soil %in% shallow_soils)

drained_hrus <- grepl(x = hru_data$lu_mgt, pattern = "_drn") %>% which()

# Intersection of HRUs which are both shallow and drained
problem_hrus <- base::intersect(shallow_hrus, drained_hrus)

length(problem_hrus)
```

Just 16 HRUs have an issue. Lets get some info on these 16:

```{r, drainfix_join}
problem_hru_data <- hru_data[problem_hrus,]

datatable(problem_hru_data)
```

We need to link the soil type to the hru vector file

```{r, drainfix_join2}
hru_shp <- read_sf("model_data/cs10_setup/optain-cs10/data/vector/hru.shp")
hru_soil <- hru_data %>% select(soil, name)
hru_shp <- left_join(hru_shp, hru_soil, by = "name")
```

And separate out our problematic HRUs and affected LUs

```{r}
problem_shps <- hru_shp %>% filter(name %in% problem_hru_data$name)
problem_hru_ids <- problem_hru_data$lu_mgt %>% str_remove("_drn_lum")
problem_lus <- hru_shp %>% filter(type %in% problem_hru_ids)
```

Next we remove the problem HRUs and affect LUs from our hru_shp (this is for the upocoming map, to remove overlaps).

```{r}
hru_shp <- hru_shp %>% filter((hru_shp$name %in% problem_lus$name) == FALSE)
hru_shp <- hru_shp %>% filter((hru_shp$name %in% problem_shps$name) == FALSE)
```

We also remove the problem HRUs from the affected LUs

```{r}
problem_lus <- problem_lus %>% filter((problem_lus$name %in% problem_shps$name) == FALSE)

```

Data processing done, lets have a look:

```{r, drainfix_map}
hru_map <-mapview(
  hru_shp,
  map.types = "Esri.WorldImagery",
  color = "green",
  lwd = 1,
  legend = FALSE,
  zcol = "soil",
  alpha.region = 0
)

problem_map <-
  mapview(
    problem_shps,
    color = "red",
    lwd = 3,
    legend = FALSE,
    zcol = "name",
    layer.name = "Problem HRUs",
    alpha.region = 0
  )

problem_lus_map <- 
  mapview(
    problem_lus,
    color = "orange",
    lwd = 1,
    legend = FALSE,
    zcol = "name",
    layer.name = "Problem LUs",
    alpha.region = 0
  )

full_map <- hru_map + problem_lus_map+ problem_map

full_map
```

Resolution to this problem has been discussed in issue [#53](https://gitlab.nibio.no/moritzshore/swat-cs10/-/issues/53)

We will extract the hru and landuse file to modify further.

```{r, drainfix_fileprep}
lum_fixed <- read.table("model_data/cs10_setup/swat_input_mod/landuse.lum", skip = 1, sep = "", header = T) %>% tibble()

hru_fixed <- read.table("model_data/cs10_setup/swat_input/hru-data.hru", skip = 1, sep = "", header = T) %>% tibble()
```

### Fixing the problem HRUs

`hru0218` with landuse `a_008f_2_drn_lum` -- Remove the drains since it is an isolated LU

```{r, drainfix_218}
lum_fixed$tile[which(lum_fixed$name=="a_008f_2_drn_lum")] = "null"
```

`hru3637` with landuse `a_148f_1_drn_lum` -- Remove the drains since it is an isolated LU.

```{r}
lum_fixed$tile[which(lum_fixed$name=="a_148f_1_drn_lum")] = "null"
```

`hru3686` of landuse `a_115f_1_drn_lum` has the wrong soil type, changing it to `"STlv-sl`" of its connected field.

```{r}
hru_fixed$soil[which(hru_fixed$name=="hru3686")] = "STlv-sl"
```

`hru4880` of landuse `a_182f_5_drn_lum` has the wrong soil type for the land use. Changing to the "`ARdy`" of neighboring fields

```{r}
hru_fixed$soil[which(hru_fixed$name=="hru4880")] = "ARdy"
```

`hru5033` with isolated landuse `a_112f_1_drn_lum` can have its drains removed.

```{r}
lum_fixed$tile[which(lum_fixed$name=="a_112f_1_drn_lum")] = "null"
```

`hru0692` of isolated land use `a_037f_1_drn_lum` can safely has its drains removed

```{r}
lum_fixed$tile[which(lum_fixed$name=="a_037f_1_drn_lum")] = "null"
```

`hru0704` has the wrong soil type for its landuse `a_037f_2_drn_lum`, which should be `STlv-sl` instead of Sea_dep_thin

```{r}
hru_fixed$soil[which(hru_fixed$name=="hru0704")] = "STlv-sl"
```

`hru3314` of landuse `a_060f_2_drn_lum` has the wrong soil type. It should be `STlv-sl`, not `STlen-rt-sl`.

The same is true for `hru3376`.

```{r}
hru_fixed$soil[which(hru_fixed$name=="hru3314")] = "STlv-sl"
hru_fixed$soil[which(hru_fixed$name=="hru3376")] = "STlv-sl"
```

`hru2784` (and the within `hru3367`) is a sizable field with landuse `a_072f_1_drn_lum` and soil `RGlen-dy-ar`. Tough call here, but best bet is probably to assign soil of the other major field it shares a landuse with (`STlv-sl`)

```{r}
hru_fixed$soil[which(hru_fixed$name=="hru2784")] = "STlv-sl"
hru_fixed$soil[which(hru_fixed$name=="hru3367")] = "STlv-sl"
```

`hru3465` of LU `a_146f_2_drn_lum` has the wrong soil for the greater field. Changing it from `RGlep-dy` to `STrt-sl`

```{r}
hru_fixed$soil[which(hru_fixed$name=="hru3465")] = "STrt-sl"
```

`hru5214` of isolated land use `a_020f_4_drn_lum` can safely have its drains removed.

```{r}
lum_fixed$tile[which(lum_fixed$name=="a_020f_4_drn_lum")] = "null"
```

`hru5861` of landuse `a_210_f2_drn_lum` does not share the same soil (end moraine) as the rest of its field.

```{r}
hru_fixed$soil[which(hru_fixed$name=="hru5861")] = "STlv-sl"
```

`hru5926` of landuse `a_211f_1_drn_lum` has the wrong soil type (`Sea-dep-thin`), changing to that of the greater field (`STrt-sl`)

```{r, drainfix_5}
hru_fixed$soil[which(hru_fixed$name=="hru5926")] = "STlv-sl"
```

`hru2633` of isolated LU `a_131f_1_drn_lum` can safely have its drains removed.

```{r, drainfix_2633}
lum_fixed$tile[which(lum_fixed$name=="a_131f_1_drn_lum")] = "null"
```

### Writing modified changes

Removing the appended columns, and duplicates from the left-join, adding header and writing to modified input files directory.

```{r, drainfix_writelu}

lu_header <- paste("lu table after fixing up by OPTAIN-CS10 workflow on", Sys.Date())

write.table(lu_header, "model_data/cs10_setup/swat_input_mod/landuse.lum", quote = F, row.names = F, col.names = F )

write.table(lum_fixed, file = "model_data/cs10_setup/swat_input_mod/landuse.lum", sep = "\t", quote = F, append = T, row.names = F, col.names = T)
```

Six drains have been removed.

```{r, drainfix_writehru}
hru_header <- paste("header header header, delete me and regret it forever! fixed soil types by cs10 worflow on", Sys.Date())

write.table(hru_header, "model_data/cs10_setup/swat_input_mod/hru-data.hru", quote = F, row.names = F, col.names = F )

write.table(hru_fixed, file = "model_data/cs10_setup/swat_input_mod/hru-data.hru", sep = "\t", quote = F, append = T, row.names = F, col.names = T)
```

Ten soil types have been changed.

### Re-enabling tiledrain

Load from modified input files

```{r, drainfix_loadcodesbsn}
old_path <- "model_data/cs10_setup/swat_input_mod/codes.bsn"
new_path <- "model_data/cs10_setup/swat_input_mod/codes.bsn"

codes_bsn <- readLines(old_path)

header <- codes_bsn[1]

header <- paste("modified by CS10 workflow on", Sys.Date())

codes_df <- read.table(old_path, skip = 1, header = T, sep = "", 
                       colClasses = "character")
```

Re-enable by setting to 1

```{r, drainfix_tiledrain}
codes_df$tiledrain <- 1
```

Writing to modified input files directory.

```{r, drainfix_writecodes}
write.table(header, file = new_path, col.names = F, row.names = F, quote = F) 

write.table(
  codes_df,
  file = new_path,
  col.names = T,
  append = T,
  quote = F,
  sep = "   ",
  row.names = F
)
```

### Testing SWAT+

Now we can see if the model runs

```{r,drainfix_swattest1, eval = run_this_chapter}
source("model_data/code/test_swat_mod.R")

simout <- test_swat_mod()
cat(tail(simout), sep = "\n")
```

Success.
