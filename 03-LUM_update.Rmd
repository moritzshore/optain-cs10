# Landuse.lum update

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

We require `tidyverse` for this since we will be using many of its
functions.

```{r, message=FALSE}
require(tidyverse)
```

## Data preperation

We read in the land use file. We want to set `skip = 1` to ignore the
SWAT+editor text, and set `header = T`. We then convert it to a `tibble`
format for better printing to console

```{r, eval}
landuse_lum <-
  read.table("model_data/cs10_setup/temp_landuse.lum", skip = 1, header = T) %>% tibble::as_tibble()
```

```{r lum_tab, tidy=FALSE, echo=FALSE}
knitr::kable(
  head(landuse_lum, 10), caption = 'The landuse.lum file, post BuildR',
  booktabs = TRUE
)
```

Our `field_id` for our cropland does not match `name` of `landuse_lum`
so we need to parse it out, we can do this many ways, but a safe way is
to split it by "\_" and combine the first 3 splits with that same
underscore: 

```{r}

splitted <- landuse_lum$name %>% str_split("_")

landuse_lum$field_id <-
  paste(splitted %>% map(1), splitted %>% map(2), splitted %>% map(3), sep = "_")

head(landuse_lum$field_id)
```
But wait, this does not work for our "non-fields". So lets find out
which ones they are, and set them to `NA`

```{r}
not_fields <- which(!grepl(x=landuse_lum$field_id, "a_"))
landuse_lum$field_id[not_fields] <- NA
```

So, what non-fields do we have?

```{r}

landuse_lum$name[not_fields]
```

Good to know. We'll keep that in mind.

## Setting `cal_group`

There is no info on this column, so we are going to leave it as `null`.

## Setting `plnt_com`

This step will be done by SWATFarmR (ref that header here!)

## Setting `mgt`

This step will be done by SWATFarmR (ref that header here!)

## Setting `urb_ro`

We want to set the `urb_ro` column for all urban land uses (in our case
this would be `urml` and `utrn`) to `usgs_reg`. We can do this like so:

```{r}

landuse_lum$urb_ro[which(landuse_lum$name %in% c("urml_lum", "utrn_lum"))] <-
  "usgs_reg"
```


```{r urbro_tab, tidy=FALSE, echo=FALSE}
prev <- landuse_lum[which(landuse_lum$name %in% c("urml_lum", "utrn_lum")), ]

knitr::kable(
  head(prev, 10), caption = 'Changing `urb_ro` in the landuse file',
  booktabs = TRUE
)
```

Very good. In our case this was only two -- could be done by hand, but
that will not be the case for all of our land uses.

## Setting `urban`

This one is easy, we set our `urban` column to an urban parameter set of
the same name. The rest we leave as `null`

```{r}
landuse_lum$urban[which(landuse_lum$name =="utrn_lum")] <- "utrn"
landuse_lum$urban[which(landuse_lum$name =="urml_lum")] <- "urml"
```
```{r urbro_tab, tidy=FALSE, echo=FALSE}
# how did we do?
prev<- landuse_lum[which(landuse_lum$name =="urml_lum"),]
knitr::kable(
  head(prev, 10), caption = 'Changing `urban` in the landuse file',
  booktabs = TRUE
)
```

Lets make sure other land uses still have `null`:

```{r, tidy=FALSE, echo=F}
knitr::kable(landuse_lum[which(landuse_lum$name == "frst_lum"), ], caption = 'Landuse `frst` in the landuse file',
             booktabs = TRUE)
```

Looks good.

## Setting Manning's n (`ovn`)

Lets get the easy ones out of the way

```{r}
landuse_lum$ov_mann[which(landuse_lum$name =="past_lum")] <- "densegrass"
landuse_lum$ov_mann[which(landuse_lum$name =="rngb_lum")] <- "rangeland_20cover"
landuse_lum$ov_mann[which(landuse_lum$name =="urml_lum")] <- "urban_rubble"
landuse_lum$ov_mann[which(landuse_lum$name =="urtn_lum")] <- "urban_asphalt"
```

Don't fall asleep yet! For `wetf` we want `forest_heavy` but with a
higher value. this means we need to add a new entry. And since we are
doing this fancy Rmarkdown stuff, we're going to do it with code! Lets
jump in and get at this file. (REMEBER TO REMOVE THE TEMP)

```{r}
ovn_table_path <- "model_data/cs10_setup/temp_ovn_table.lum"
ovn_table <- readLines(ovn_table_path)
```

Good, now where is this forest heavy entry? and what does the format
look like?

```{r}
index <- grepl(x=ovn_table, "forest_heavy") %>% which %>% min()

ovn_table[c(2, index)] %>% print()
```

Now, lets make our own and add it in. But only if it doesn't exist it
(Like if the script has been run before...)

```{r}
if(grepl(x = ovn_table, "forest_heavy_cs10") %>% which %>% length() == 0) {
  entry <-
    "forest_heavy_cs10      0.90000       0.80000       0.95000  Forest_heavy_mod"
  ovn_table <- c(ovn_table, entry)
}
```

Did it work? Yes:

```{r}
ovn_table %>% tail()
```

Now lets write this new table

```{r}
writeLines(ovn_table, con = ovn_table_path)
```

And now we can enter our wetland class:

```{r}
landuse_lum$ov_mann[which(landuse_lum$name =="wetf_lum")] <- "forest_heavy_cs10"
```

STOP HERE STOP HERE STOP HERE

We need to do the crop rotation first before we cont.