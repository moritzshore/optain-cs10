# Climate inputs and weather generator

## Preparation and loading data

To add weather and climate data to our SWAT project, we will use `svatools` [@svajunas2023]

### Required packages

```{r, loadpacks_climweath, message=FALSE}
require(euptf2) # devtools::install_github("tkdweber/euptf2") 
require(svatools) # devtools::install_github("biopsichas/svatools")
require(readr)
require(readxl)
require(sf)
require(mapview)
require(ggpot2)
require(tidyr)
```

### Load in the file(s) and load svatools template

First we load in the template and fill it in with our values and rename it to "cs10_weather_data.xlsx". This is not done within R. No detailed documentation exists on the source of this data (yet).

```{r}
#temp_path <- system.file("extdata", "weather_data.xlsx", package = "svatools")
# /// fill out this template and save "cs10_weather_data.xlsx" ///
```

We are using the following projection for this project:

```{r}
epgs_code = 25832
```

Now we can load it in with Svatools.

```{r}
met_lst <- load_template(template_path = "model_data/input/met/cs10_weather_data.xlsx", epgs_code)
```

### Proof the station

```{r, svatool_plot_weather}
plot_weather(met_lst, "PCP", "month", "sum")
```

Checking the location of the station:

```{r}
basin_path <- "model_data/input/shape/cs10_basin.shp"
basin <- st_transform(st_read(basin_path), epgs_code) %>%
  mutate(NAME = "Basin")

stations <- st_transform(met_lst$stations, epgs_code)
mapview(stations) + mapview(basin)
```

## Creating the weather generator

We only have one weather station, which means only one weather generator.

```{r}
wgn <- prepare_wgn(met_lst, 
                   TMP_MAX = met_lst$data$ID1$TMP_MAX, 
                   TMP_MIN = met_lst$data$ID1$TMP_MIN, 
                   PCP = met_lst$data$ID1$PCP, 
                   RELHUM = met_lst$data$ID1$RELHUM, 
                   WNDSPD = met_lst$data$ID1$WNDSPD, 
                   MAXHHR = met_lst$data$ID1$MAXHHR, 
                   SLR = met_lst$data$ID1$SLR)

write.csv(wgn$wgn_st, "model_data/input/met/as_wgn_st.csv", row.names = FALSE, quote = FALSE)

write.csv(wgn$wgn_data, "model_data/input/met/as_wgn_data.csv", row.names = FALSE, quote = FALSE)
```

## Adding weather data to SWAT+ project

This adds the weather generator and weather stations to our SWAT+ project

```{r, eval=FALSE}
db_path <- "model_data/cs10_setup/optain-cs10/optain-cs10.sqlite"
add_weather(db_path, met_lst, wgn)
```

## Adding Atmospheric deposition

Instructions and documentation can be found
[here](https://biopsichas.github.io/svatools/articles/deposition.html)

Getting the data:

```{r, eval = FALSE}
basin_path <- "model_data/input/shape/cs10_basin.shp"
df <-
  get_atmo_dep(
    basin_path,
    start_year = 2010,
    end_year = 2020,
    t_ext = "year"
  )
```
A plot of the results:

```{r, eval = FALSE}
ggplot(pivot_longer(df, !DATE, names_to = "par", values_to = "values"), aes(x = DATE, y = values))+ 
  geom_line()+ 
  facet_wrap(~par, scales = "free_y")+ 
  theme_bw()
```

Adding the data to the SQLITe

```{r, eval = FALSE}
db_path <- "model_data/cs10_setup/optain-cs10/optain-cs10.sqlite"
add_atmo_dep(df, db_path)
```
Big thank you to Svajunas for his svatools package, making our lives much easier!
