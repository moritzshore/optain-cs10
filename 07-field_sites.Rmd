# Field Site Properties

For various use-cases across the modelling project, we will require certain
information about the locations of the field sites. This section gathers that
information and makes it available to other sections.

## Determining the HSG group of the logger sites

```{r, message=FALSE}
require(sf)
require(readr)
require(DT)
require(dplyr)
require(mapview)
require(ggplot2)

sf_theme <- theme(axis.text.x=element_blank(), #remove x axis labels
        axis.ticks.x=element_blank(), #remove x axis ticks
        axis.text.y=element_blank(),  #remove y axis labels
        axis.ticks.y=element_blank()  #remove y axis ticks
        )
```

We load the soil map of the area.

```{r}
soil_map <- "model_data/input/soil/soil_map_UTM32N.shp"
soil_map_shp <- read_sf(soil_map)
```

We will crop it by the watershed. Therefore we load the water shed

```{r}
cs10_basin_path <- "model_data/input/shape/cs10_basin.shp"
cs10_basin <- read_sf(cs10_basin_path)
```

And crop by by basin. (current not sure of the effect of constant geometry)

```{r message=FALSE, warning=FALSE}
st_agr(soil_map_shp) = "constant"
st_agr(cs10_basin) = "constant"

soil_map_shp <- st_intersection(soil_map_shp, cs10_basin)

```

```{r, soilmapplot, fig.cap="Soil map of CS10, in shapefile format", fig.align='center'}
ggplot()+geom_sf(soil_map_shp, mapping = aes(fill = SNAM))+sf_theme
```

We need information on the soil itself. This is found in our user table. We only
need the hydrologic soil group (HSG) `HYDGRP`, but we will keep the soil depth
`SOL_ZMX` and soil texture `TEXTURE` just in case

```{r}
usersoil_path <- "model_data/input/soil/UserSoil_Krakstad.csv"
usersoil <- read_csv(usersoil_path, show_col_types = F)
usersoil <- usersoil %>% dplyr::select(OBJECTID, SNAM, SOL_ZMX, HYDGRP, TEXTURE)

```

```{r, echo = FALSE}
datatable(usersoil,
          extensions = "Scroller",
          options = list(scrollY = 200, scroller = TRUE)
)
```

We can combine the two data sets with a left join by soil ID / Object ID

```{r}
usersoil$SOIL_ID <- usersoil$OBJECTID

usersoil <- usersoil %>% dplyr::select(-OBJECTID)

soil_propery_map <- dplyr::left_join(soil_map_shp, usersoil, by = "SOIL_ID")

```

```{r, fig.align="center", fig.cap="HSG of CS10"}
ggplot()+geom_sf(soil_propery_map, mapping = aes(fill = HYDGRP))+sf_theme

```


Now we need the locations of the field sites. These are stored as points in the
following file:

```{r}
cs10_field_sites_path <- "model_data/field_sites/geospatial/cs10_field_sites.shp"
cs10_field_sites <- read_sf(cs10_field_sites_path)
```

We are going to join the attributes using a spatial join

```{r}
field_sites_attr <- st_join(cs10_field_sites, soil_propery_map)
```

Here is the result:

```{r, echo = FALSE, fig.cap="Field site locations of CS10"}
fs_map <-
  mapview(
    field_sites_attr,
    zcol = "HYDGRP",
    color = "black",
    layer.name = "Field Sites",
    label = "id",
    lwd = 3, legend = FALSE
  )

ws_map <- mapview(read_sf("model_data/input/shape/cs10_basin.shp"), alpha.regions = .2)

ws_map+fs_map
```

We have two sites covering C and D, and one site covering B. This covers all
existing HSGs in the catchment, which is good. We can save this information in
a dataframe.

```{r}
field_site_attr_df <- st_drop_geometry(field_sites_attr)

datatable(field_site_attr_df)
```
We will write this into our output folder

```{r}
write_csv(x = field_site_attr_df, file = "model_data/field_sites/output/field_site_attr_df.csv")
```

And save our soil property map, and field site points (with attributes)

```{r, messages=FALSE}
# TODO fix the weird ID column mess you made
write_sf(field_sites_attr, "model_data/field_sites/output/field_site_attr_map.shp")
write_sf(soil_propery_map, "model_data/field_sites/output/soil_propery_map.shp")
```

