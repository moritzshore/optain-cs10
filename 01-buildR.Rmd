# Model setup with SWATBuildR

The OPTAIN project is using the COCOA approach @schürz2022 and as such, needs to use the `SWATBuildR` package to calculate the connectivity between HRUs in the catchment. This chapter covers this process.

We will define the location of our project here:

```{r}
project_path <- 'model_data/cs10_setup'
```

And give it the name:

```{r}
project_name <- 'optain-cs10'
```

Much of this documentation has been lost to time.

We will need the following packages for this chapter:

```{r, message=FALSE}
require(mapview)
require(sf)
```

## High-Resolution Digital Elevation Model (DEM)

The high-resolution DEM is the basis for calculation of water connectivity, among other things. Most of the documentation of the creation of the DEM for CS10 has been lost to the sands of time. All we know is that it is located here:

```{r}
dem_path <- "model_data/input/elevation/dtm3_ns_v5.tif"
```

```{r, message=FALSE}

plot(raster::raster(dem_path), main = "CS10 DEM, UTM32N")

```

To our knowledge, it has a 10 meter resolution. 1 meter resolution was available but there seems to have been issues with using it. It is definitely preferable to use the 1m DEM as certain important information can be lost with (max allowed resolution) of 10m, see Figure \@ref(fig:dempic).

![#label:dempic An example of a hydrologically effective landscape features being lost due to coarse DEM resolution. From[@schürz2022]](figures/1mdemvs10.png)

## Basin Boundary

The basin boundary has presumably been created using the defined outlet point of the catchment and the DEM. No more is currently known about this file other than that it is located here:

```{r}
bound_path <- "model_data/input/shape/cs10_basin.shp"
```

```{r, message=FALSE, echo=FALSE}
bound_sf <- read_sf(bound_path)
bound_sf$Id = "CS10 Basin"
bound_map <- mapview(bound_sf, color = "black", col.regions = "orange", alpha.region = .2)
bound_map
```

We will begin using the `SWATBuildR` Package by initializing its functions. (Note: this package is currently unfinished, which is why this step is necessary).

The following code is from version `1.5.12`, and written by Christoph Schuerz.

Another note: there are currently issues with White box which are being resolved.

```{r, message=FALSE}
source('model_data/swat_buildR/init.R')
```

First, we read in and check the basin boundary and run some checks

```{r}
bound <- read_sf(bound_path) %>% select()
set_proj_crs(bound, data_path)
check_polygon_topology(layer = bound, data_path =  data_path, label = 'basin', 
                       n_feat = 1, checks = c(F,T,T,T,F,F,F,F))
```

## Land layer

Our land layer is located here:

```{r}
land_path <- "model_data/input/land/CS10_LU.shp"
```

Documentation on its creation does not exist.

```{r, message=F, echo=F}
mapview(read_sf(land_path), zcol = "KGB", legend = FALSE)
```

We had an issue with the classification of the land uses. For the OPTAIN project, all agricultural fields must have a unique ID, and our land uses only had the ID of the given farm `KGB` (which had many different fields). To remedy this, new IDs were generated with the format `a_###f_#` where `a_` represents the farm, and `f_` represents the respective field of that farm. The farm names needed to be shortened because the SWAT+ model often cannot handle long ID names (longer than 16 characters)

```{r}
readr::read_csv("model_data/farm_id/a_f_id.csv", show_col_types = F) %>% head()
```

This was done in a simple QGIS workflow of dissolving by farm, splitting from single part to multipart, and then adding an iterating ID per farm. This workflow could be replicated in R, and shown here. It is under consideration.

This is our map with the new `type` IDs:

```{r, message=FALSE}
lu_map <- mapview(read_sf(land_path), zcol = "type", legend = FALSE)

lu_map
```

BuildR will now run some checks on our land layer:

```{r}
land <- read_sf(land_path) %>% 
  check_layer_attributes(., type_to_lower = FALSE) %>%
  check_project_crs(layer = ., data_path =  data_path, proj_layer = project_layer, 
                    label = 'land', type = 'vector')

check_polygon_topology(layer = land, data_path =  data_path, label = 'land', 
                       area_fct =  0.00, cvrg_frc = 99.9,
                       checks = c(T,F,T,T,T,T,T,T))
```

BuildR splits the land layer into HRU (land) and reservoir (water) objects

```{r}
split_land_layer(data_path)
```

## Channels

No documentation exists on the source of the channels layer, all we know is that it is located here:

```{r}
channel_path <- 'model_data/input/line/cs10_channels.shp'
channels <- read_sf(channel_path) %>% select("type")
plot(channels)
```

BuildR runs some checks:

```{r}
 channel <- read_sf(channel_path) %>% 
    check_layer_attributes(., type_to_lower = TRUE) %>% 
    check_project_crs(layer = ., data_path =  data_path, proj_layer = project_layer, 
                      label = 'channel', type = 'vector')
  ## Check function saves layer into data/vector after all checks were successful
  check_line_topology(layer = channel, data_path = data_path, 
                      label = 'channel', length_fct = 0, can_cross = FALSE)
```
And gives this output:
```{r}

channels <- read_sf("model_data/cs10_setup/optain-cs10/data/vector/channel.shp")
channel_map <- mapview(channels, zcol = "type")

bound_map+channel_map
```